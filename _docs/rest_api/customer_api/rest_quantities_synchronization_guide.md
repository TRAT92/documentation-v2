Бизнес-цель: предоставить руководство (лучшие практики) по синхронизации
Заказчик: Евгений Захаров, Павел Тарбеев.
Целевая аудитория: Разработчики ТУ, которые используют API Облака Эвотор
Проблема ЦА: не понимают процесса первичной синхронизации, в области остатков
Сценарии использования: руководство (туториал), т.е. по шагам от начала до конца.

!брать id товара и искать самый свежий документ!

1. Запросить список магазинов клиента: вся номенклатура хранится в разрезе магазина, а не терминала (**УТОЧНИТЬ**). К одному магазину может быть привязано неограниченное количество терминалов. Все остатки ведутся в рамках магазина
2. Запросить документы клиента за период 6 месяцев (необходимо выполнить 6 запросов помесячно(V1), в случае если терминалов много, то и потерминально (**УТОЧНИТЬ ЗА КАКОЙ ПЕРИОД СЛЕДУЕТ ЗАПРАШИВАТЬ ДОКУМЕНТЫ И ОГРАНИЧЕНИЯ СООТВЕТСТВУЮЩИХ ВЕРСИЙ API**))
3. Запросить номенклатуру клиента (если у клиента не было ТУ, то все остатки по товарам вы получите нулевыми) по магазинам.
4. Используя uuid товара ваше приложение должно «пробежаться» по коллекции документов. Находим самый свежий документ, в котором присутствует данный uuid товара. Если это документ продажи (в нем указан остаток на момент операции и количество которое продают), вычитаем количество по операции из количества на момент продаже. Записываем остаток соответствующему uuid-у в поле quantity. Если это документ приемки – просто берем указанный остаток. Если это документ возврата, то действуем как и в случае с документом продажи. Но не вычитаем, а прибавляем quantity по операции.

Когда остаток записан, цикл проверки документов может быть завершен.
При формировании остатков необходимо обращать  внимание на дату документа и его тип.

Те товары, по которым нет документов за полугодовой период, следует оставить без изменений. (**Выделить в отдельный блок ПРИМЕЧАНИЕ или ВАЖНО**) -- ИДЕАЛЬНО ПРОВЕСТИ ИНВЕНТАРИЗАЦИЮ
В фоновом режиме можно продолжать запрашивать документы за более старый период. Возможно, документ по данному товару был раньше.

UID МАГАЗИНА НАЧИНАЕТСЯ С ДАТЫ РЕГИСТРАЦИИ

5. Собрав у себя номенклатуру и остатки по ней, отправляем POST - запрос с данными в облако (**дать ссылку на эндпоинт**)
6. На терминале рекомендуем клиенту произвести  загрузку обновленных данных из облака Эвотор. (****)


---
title: Корректная обработка остатков при первой синхронизации ТУ и Облака Эвотор
permalink: rest_quantities_synchronization_guide.html
sidebar: evorestguides
product: Customer API
---

Когда пользователь впервые устанавливает ТУ это может привести к нарушению количества или обнулению остатков товаров. Такое поведение ТУ можно объяснить неочевидным способом получения остатков, актуальных на момент установки приложения.

В этой статье приводится один из возможных способов получения актуальных остатков. Придерживаясь этого способа, ТУ смогут обезопасить своих пользователей от нежелательных последствий первичной синхронизации.

*Чтобы корректно определить актуальные остатки:*

1. Используйте метод [`GET /stores`](./ссылка_на_справочник), чтобы узнать список магазинов пользователя.

   Одному магазину может соответствовать множество смарт-терминалов, поэтому товарная номенклатура, а соответственно и учёт остатков, ведётся в контексте магазина.

2. Используйте метод [GET /stores/{store-id}/products](./), чтобы получить номенклатуру каждого из магазинов пользователя.

   {% include warning.html content="Если пользователь впервые устанавливает ТУ, остатки всех товаров будут нулевыми. (**УТОЧНИТЬ ПОЧЕМУ ТЕРМИНАЛ НИЧЕГО НЕ СКЛАДЫВАЕТ В ОБЛАКО ДО ПЕРВОЙ УСТАНОВКИ ТУ**)" %}

3. Используйте метод [GET /stores/{store-id}/documents](./), чтобы получить весь список документов магазина за последние шесть месяцев.

   Получение большого количества документов может оказаться времязатратным и ресурсоёмким процессом. Чтобы упростить эту задачу вы можете выполнить шесть запросов по каждому месяцу, а также разделить запросы по смарт-терминалам (метод [GET /stores/{store-id}/devices/{device-id}/documents](./)), если у пользователя много устройств в одном магазине.

4.

5. Используйте метод , чтобы передать в Облако Эвотор актуальные данные об остатках.
6.

Запросить документы клиента за период 6 месяцев (необходимо выполнить 6 запросов помесячно(V1), в случае если терминалов много, то и потерминально (**УТОЧНИТЬ ЗА КАКОЙ ПЕРИОД СЛЕДУЕТ ЗАПРАШИВАТЬ ДОКУМЕНТЫ И ОГРАНИЧЕНИЯ СООТВЕТСТВУЮЩИХ ВЕРСИЙ API**))
