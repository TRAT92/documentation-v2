---
title: Корректная обработка остатков при первой синхронизации ТУ и Облака Эвотор
permalink: rest_quantities_synchronization_guide.html
sidebar: evorestguides
product: Customer API
---

Когда пользователь впервые устанавливает ТУ это может привести к нарушению количества или обнулению остатков товаров. Такое поведение ТУ можно объяснить неочевидным способом получения остатков, актуальных на момент установки приложения.

В этой статье приводится один(**Один ли?**) из возможных способов получения актуальных остатков. Придерживаясь этого способа, вы сможете обезопасить своих пользователей от нежелательных последствий первичной синхронизации.

*Чтобы корректно определить актуальные остатки:*

1. Узнайте список магазинов пользователя с помощью метода [`GET /stores`](./rest_stores.html#получить-список-магазинов).

   Одному магазину может соответствовать множество смарт-терминалов, поэтому товарная номенклатура и учёт остатков, ведутся в контексте магазина.

2. Получите номенклатуру каждого из магазинов пользователя с помощью метода [`GET /stores/{store-id}/products`](./rest_products.html#получить-все-товары).

   {% include note.html content="Если пользователь впервые устанавливает ТУ, остатки всех товаров будут нулевыми. (**УТОЧНИТЬ ПОЧЕМУ ТЕРМИНАЛ НИЧЕГО НЕ СКЛАДЫВАЕТ В ОБЛАКО ДО ПЕРВОЙ УСТАНОВКИ ТУ**)" %}

3. Получите список всех документов магазина за последние шесть месяцев с помощью метода [`GET /stores/{store-id}/documents`](./rest_documents.html#получить-список-документов).

   Получение большого количества документов может оказаться ресурсоёмким. Чтобы упростить эту задачу вы можете выполнить шесть запросов по месяцу, а также разделить запросы по смарт-терминалам (метод [`GET /stores/{store-id}/devices/{device-id}/documents`](./rest_documents.html#получить-список-документов)), если у пользователя много устройств в одном магазине.

4. Теперь, когда вы знаете идентификаторы всех товаров и документов, необходимо найти самый новый документ, соответствующий каждому из товаров. В зависимости от типа документа реализуйте следующую логику:

   * Если последним документом по товару был [документ приёмки](./rest_accept.html), используйте в указанные в нём остатки товара.
   * Если последним документом по товару был [документ продажи](./rest_sell.html), из указанных в нём остатков необходимо вычесть количество проданного товара.
   * Если последним документом по товару был [документ возврата](./rest_payback.html), к указанным в нём остаткам необходимо добавить количество возвращённого товара.

   Полученные таким образом остатки запишите в поле `quantity` каждого из товаров.

   {% include important.html content="Если за последние шесть месяцев документов по товару не обнаружено, оставьте товар без изменений, продолжая в фоновом режиме запрашивать более старые документы." %}
   {% include tip.html content="Вы также можете сообщить пользователю по каким товарам не удалось получить актуальные остатки и рекомендовать ему провести инвентаризацию." %}

5. Обновите остатки в Облаке Эвотор с помощью метода [`PATCH /stores/{store-id}/products/{product-id}`](./rest_products.html#обновить-остатки-товара).
6. Сообщите пользователям о необходимости загрузить на смарт-терминалы обновлённые данные из Облака Эвотор.
